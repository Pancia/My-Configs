#!/usr/bin/env zsh

local staged_changes="$(git diff --staged --unified=0)"

ag 'test/focused' <(echo $staged_changes | ag '^\+') \
    && echo "[pre-commit/ERROR]: Found focused tests!" >&2 \
    && exit 11

local markers="$(echo $staged_changes | ag '^\+' | ag 'TASK')"
if [[ -n "$markers" ]]; then
    echo "[pre-commit/ERROR]: Found staged TASK markers:"
    echo $markers
    exit 12
fi

git flow config &> /dev/null \
  || echo "[pre-commit/WARNING]: Not a gitflow-enabled repo yet. Please run 'git flow init' first."

local dev_branch="$(git flow config 2> /dev/null | ag -o 'development: (\w+)' | ag -o '\w+$' || echo 'master')"

local markers="$(git diff $dev_branch...HEAD | ag '^\+' | ag 'TASK')"
if [[ -n "$markers" ]]; then
    echo "[pre-commit/ERROR]: Found TASK markers in branch:"
    echo $markers
    exit 13
fi

exit 0
